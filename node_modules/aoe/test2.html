<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        canvas{
            border:1px solid #000;
            outline:none;
        }
        .canvas-ctn{
            position:relative;
        }
        #shape{
            position:absolute;
            left:0;
            right:0;
        }
        .tool-ctn{
            font-size: 0;
            border-right: 1px solid #000;
            display: inline-block;
        }
        .tool-ctn>div{
            display: inline-block;
            border: 1px solid #000;
            padding: 2px 5px;
            font-size: 14px;
            border-right-width: 0;
            cursor: pointer;
        }
        .tool-ctn .selected{
            background: #3879d9;
            color: #fff;
        }
    </style>
    <script src="editor.js"></script>
</head>
<body>

<input type="file" id="file" accept="image/*" multiple>

<div id="cr_ctn" style="display: none">
    <input type="text" id="column" placeholder="列数">x <input type="text" id="row" placeholder="行数">

</div>
<div>
    <button id="create">创建</button>
</div>
<div class="canvas-ctn">
<canvas width="300" height="300" id="cvs"></canvas>
<canvas width="300" height="300" id="shape" tabindex="1"></canvas>

</div>
<div class="tool-ctn">
    <div class="selected">Rectangle</div>
    <div>Polygon</div>
    <div>Ellipse</div>
</div>
<div>
    <input type="text" id="area" placeholder="设置Area">
</div>

<div>
    <button id="prev" style="display:none;">上一个</button>
    <button id="next" style="display:none;">下一个</button>
</div>


<script type="text/javascript">
    var $ = document.querySelector.bind(document)
    var $$ = document.querySelectorAll.bind(document)
    var $file = $('#file')
    var $canvas=$('#cvs')
    var $shapeCanvas=$('#shape')
    var ctx=$canvas.getContext('2d')
    var column,row,curImageIndex=0
    let images = []
    var imageLoad=0
    let shapeEditor=new ShapeEditor($shapeCanvas)
    shapeEditor.on('shapeSelected',function(shape){
        $('#area').value=shape.area||''
    })
    $('#area').onchange=function(){
        if(shapeEditor.selectedShape){
            shapeEditor.selectedShape.area=this.value
        }
    }
    document.querySelector('.tool-ctn').addEventListener('click',function(event){
        console.log(event)
        document.querySelectorAll('.tool-ctn>div').forEach((n)=>{
            n.className=n!==event.target?'':'selected'
            shapeEditor.setShapeType(event.target.innerText)
        })
    })
    $file.onchange = function () {
        if (file.files.length > 1) {
            $('#cr_ctn').style.display = 'none'
        }
        else {
            $('#cr_ctn').style.display = 'block'
        }
    }
    let fileReader = new FileReader()
    $('#create').onclick = function () {

        let index = 0
        column=$('#column').value
        row=$('#row').value
        if(column==0||row==0){
            alert('行数和列数必须大于0')
            return
        }
        fileReader.readAsDataURL($file.files[index++])
        fileReader.onload = function (e) {
            let img = new Image()
            img.src = fileReader.result
            images.push(img)
            img.onload=allImageLoaded
            if (index < $file.files.length) {
                fileReader.readAsDataURL($file.files[index++])
            }
            else{



            }
        }
        fileReader.onprogress = function (e) {
        }

    }

    function allImageLoaded(){
        if(++imageLoad>=$file.files.length){
            resize(column,row)
            draw(curImageIndex++)
        }

    }
    function resize(column,row){
        if(images.length>1){
            $canvas.width=images[0].width
            $canvas.height=images[0].height
            $shapeCanvas.width=images[0].width
            $shapeCanvas.height=images[0].height
        }
        else if(images.length==1){
            $canvas.width=images[0].width/column
            $canvas.height=images[0].height/row
            $shapeCanvas.width=images[0].width/column
            $shapeCanvas.height=images[0].height/row
        }

        $('#next').style.display='block'
        $('#next').onclick=function(){
            draw(curImageIndex++)
        }
    }
    function draw(index){
        ctx.clearRect(0,0,$canvas.width,$canvas.height)
        if(images.length>1){
            index=index%images.length
            ctx.drawImage(images[index],0,0)

        }
        else{
            index=index%(column*row)
            let width=$canvas.width,
                    height=$canvas.height
            ctx.drawImage(images[0],index%column*width,Math.floor(index/column)*height,width,height,0,0,width,height)
        }
    }

</script>
</body>
</html>